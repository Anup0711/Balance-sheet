<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Balance Sheet App (‚Çπ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- jsPDF + AutoTable for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.1);
      --accent-strong: #16a34a;
      --border: #1f2937;
      --border-soft: #374151;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.12);
      --shadow-soft: 0 14px 35px rgba(0, 0, 0, 0.4);
      --radius-lg: 18px;
      --radius-md: 10px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(18px);
    }

    .app-header {
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, #020617, #111827);
      border-bottom: 1px solid var(--border-soft);
      gap: 12px;
      flex-wrap: wrap;
    }

    .title-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .logo-pill {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, #22c55e, #059669);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 10px 25px rgba(34, 197, 94, 0.5);
      color: #022c22;
    }

    .title-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .title-text h1 {
      margin: 0;
      font-size: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title-text h1 span.currency {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .title-text small {
      color: var(--text-soft);
      font-size: 12px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.9);
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.18s ease;
      white-space: nowrap;
    }

    .btn.primary {
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      border-color: transparent;
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.45);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 7px 16px rgba(0, 0, 0, 0.5);
      border-color: rgba(148, 163, 184, 0.9);
    }

    .btn.primary:hover {
      filter: brightness(1.05);
      box-shadow: 0 10px 24px rgba(34, 197, 94, 0.65);
    }

    .btn-icon {
      font-size: 14px;
    }

    .ribbon {
      padding: 10px 16px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(15,23,42,0.9), rgba(15,23,42,0.6));
    }

    .ribbon-group {
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-soft);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      flex-wrap: wrap;
    }

    .ribbon-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-soft);
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31,41,55,0.9);
    }

    .ribbon-group .btn {
      padding: 6px 10px;
      font-size: 11px;
    }

    .ribbon-divider {
      width: 1px;
      background: var(--border-soft);
      align-self: stretch;
    }

    .main-grid {
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 10px;
      padding: 10px 16px 14px;
      height: 100%;
      min-height: 0;
    }

    .formula-bar {
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border-soft);
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      overflow: hidden;
    }

    .formula-label {
      padding: 6px 10px;
      border-right: 1px solid var(--border-soft);
      font-size: 11px;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.96);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .formula-input {
      padding: 4px 10px;
      font-size: 12px;
      color: var(--text-soft);
      min-height: 32px;
      display: flex;
      align-items: center;
      overflow-x: auto;
      white-space: nowrap;
    }

    .sheet-wrapper {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.06), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.08), transparent 55%),
                  rgba(15, 23, 42, 0.96);
      border: 1px solid var(--border-soft);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .sheet-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      gap: 8px;
      flex-wrap: wrap;
    }

    .sheet-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .sheet-name {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 1);
      border: 1px solid var(--accent-soft);
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .sheet-name-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    .sheet-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill strong {
      color: var(--accent);
    }

    .sheet-container {
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding: 8px;
    }

    table.sheet {
      border-collapse: collapse;
      width: 100%;
      min-width: 650px;
      background: rgba(15, 23, 42, 0.96);
      font-size: 12px;
    }

    table.sheet thead {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(0deg, #020617, #020617);
    }

    table.sheet th,
    table.sheet td {
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      text-align: left;
    }

    table.sheet th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-soft);
      background: linear-gradient(0deg, #020617, #020617);
      position: relative;
    }

    table.sheet th:first-child,
    table.sheet td:first-child {
      background: rgba(15, 23, 42, 0.96);
      text-align: center;
      width: 40px;
      min-width: 40px;
      color: var(--text-soft);
      font-size: 11px;
    }

    table.sheet tr:nth-child(even) td:not(:first-child) {
      background: rgba(15, 23, 42, 0.98);
    }

    table.sheet tr:nth-child(odd) td:not(:first-child) {
      background: rgba(15, 23, 42, 0.93);
    }

    table.sheet tr:hover td {
      background: rgba(15, 23, 42, 0.9);
    }

    .cell-input,
    .cell-select {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 12px;
      padding: 2px 0;
    }

    .cell-input::placeholder {
      color: rgba(148, 163, 184, 0.6);
    }

    .cell-select {
      cursor: pointer;
    }

    .cell-input.amount {
      text-align: right;
    }

    .rupee-prefix {
      color: var(--text-soft);
      margin-right: 4px;
      font-size: 11px;
    }

    .amount-cell {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 2px;
    }

    .action-cell {
      text-align: center;
    }

    .row-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      font-size: 11px;
      padding: 2px 7px;
      cursor: pointer;
      transition: 0.16s ease;
    }

    .row-btn:hover {
      background: rgba(127, 29, 29, 0.9);
      color: #fecaca;
      border-color: rgba(248, 113, 113, 0.8);
    }

    .summary-bar {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      font-size: 11px;
    }

    .summary-card {
      border-radius: var(--radius-md);
      padding: 7px 9px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .summary-value {
      font-size: 13px;
      font-weight: 600;
    }

    .summary-value span.rupee {
      font-size: 11px;
      color: var(--text-soft);
      margin-right: 2px;
    }

    .summary-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .summary-badge.ok {
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .summary-badge.bad {
      background: var(--danger-soft);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .summary-hint {
      font-size: 10px;
      color: var(--text-soft);
    }

    .summary-badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
    }

    .app-footer {
      padding: 6px 14px 10px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-soft);
      gap: 10px;
      flex-wrap: wrap;
    }

    .footer-left,
    .footer-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .kbd {
      padding: 1px 5px;
      border-radius: 4px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,0.9);
      font-size: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @media (max-width: 800px) {
      .ribbon {
        flex-direction: column;
        align-items: stretch;
      }
      .ribbon-group {
        width: 100%;
        justify-content: flex-start;
      }
      .summary-bar {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 520px) {
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-actions {
        align-self: stretch;
        justify-content: space-between;
      }
      .summary-bar {
        grid-template-columns: 1fr;
      }
      table.sheet {
        min-width: 550px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="title-wrap">
        <div class="logo-pill">‚Çπ</div>
        <div class="title-text">
          <h1>
            Balance Sheet
            <span class="currency">INR</span>
          </h1>
          <small>Excel-style sheet to track Assets, Liabilities &amp; Equity</small>
        </div>
      </div>
      <div class="header-actions">
        <div class="chip">
          <span class="chip-dot"></span>
          Auto totals &amp; balance check (saved locally)
        </div>
        <button class="btn" type="button" id="resetSheetBtn">
          <span class="btn-icon">üßπ</span> Reset sheet
        </button>
        <button class="btn primary" type="button" id="addRowBtn">
          <span class="btn-icon">Ôºã</span> Add row
        </button>
      </div>
    </header>

    <div class="ribbon">
      <div class="ribbon-group">
        <div class="ribbon-label">Rows</div>
        <button class="btn" type="button" id="addRowBtn2">Ôºã Row</button>
        <button class="btn" type="button" id="recalcBtn">‚ü≥ Recalculate</button>
      </div>

      <div class="ribbon-divider"></div>

      <div class="ribbon-group">
        <div class="ribbon-label">Export</div>
        <button class="btn" type="button" id="downloadExcelBtn">üìä Excel</button>
        <button class="btn" type="button" id="downloadCsvBtn">üìÑ CSV</button>
        <button class="btn" type="button" id="downloadPdfBtn">üìë PDF</button>
        <button class="btn" type="button" id="downloadHtmlBtn">üåê HTML</button>
        <button class="btn" type="button" id="downloadJsonBtn">üß© JSON</button>
      </div>
    </div>

    <div class="main-grid">
      <div class="formula-bar">
        <div class="formula-label">Active Cell</div>
        <div class="formula-input" id="formulaDisplay">
          Click any cell to see / edit details
        </div>
      </div>

      <div class="sheet-wrapper">
        <div class="sheet-header">
          <div class="sheet-header-left">
            <div class="sheet-name">
              <div class="sheet-name-dot"></div>
              Sheet1 - Balance Sheet
            </div>
          </div>
          <div class="sheet-header-right">
            <div class="pill">
              Mode: <strong>Assets / Liabilities / Equity</strong>
            </div>
          </div>
        </div>

        <div class="sheet-container">
          <table class="sheet" id="balanceSheet">
            <thead>
              <tr>
                <th>#</th>
                <th>Item / Account</th>
                <th>Category</th>
                <th>Amount (‚Çπ)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="sheetBody">
              <!-- Rows injected by JS -->
            </tbody>
          </table>

          <div class="summary-bar">
            <div class="summary-card">
              <div class="summary-label">Total Assets</div>
              <div class="summary-value" id="totalAssets">
                <span class="rupee">‚Çπ</span>0.00
              </div>
              <div class="summary-hint">Should equal Liabilities + Equity</div>
            </div>

            <div class="summary-card">
              <div class="summary-label">Total Liabilities</div>
              <div class="summary-value" id="totalLiabilities">
                <span class="rupee">‚Çπ</span>0.00
              </div>
              <div class="summary-hint">Loans, creditors, outstanding amounts</div>
            </div>

            <div class="summary-card">
              <div class="summary-label">Total Equity</div>
              <div class="summary-value" id="totalEquity">
                <span class="rupee">‚Çπ</span>0.00
              </div>
              <div class="summary-hint">Capital, reserves, retained earnings</div>
            </div>

            <div class="summary-card">
              <div class="summary-label">Balance Status</div>
              <div id="balanceStatus" class="summary-badge bad">
                <span class="summary-badge-dot"></span>
                Not balanced
              </div>
              <div class="summary-hint" id="differenceHint">
                Difference: <span class="rupee">‚Çπ</span>0.00
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="app-footer">
        <div class="footer-left">
          <span class="status-dot"></span>
          <span id="footerStatus">Ready</span>
        </div>
        <div class="footer-right">
          <span>Data is stored only in your browser (local).</span>
          <span class="kbd">Assets = Liabilities + Equity</span>
        </div>
      </footer>
    </div>
  </div>

  <script>
    var STORAGE_KEY = "balanceSheetDataV1";

    function nodeListForEach(list, cb) {
      Array.prototype.forEach.call(list, cb);
    }

    function formatAmount(value) {
      var num = Number(value) || 0;
      return num.toFixed(2);
    }

    function createRow(itemValue, categoryValue, amountValue) {
      if (itemValue === undefined) itemValue = "";
      if (categoryValue === undefined) categoryValue = "Asset";
      if (amountValue === undefined) amountValue = "";

      var tbody = document.getElementById("sheetBody");
      var row = document.createElement("tr");

      var indexCell = document.createElement("td");
      indexCell.className = "index-cell";
      row.appendChild(indexCell);

      var itemCell = document.createElement("td");
      var itemInput = document.createElement("input");
      itemInput.type = "text";
      itemInput.className = "cell-input";
      itemInput.name = "item";
      itemInput.placeholder = "e.g. Cash, Bank, Furniture";
      itemInput.value = itemValue;
      itemCell.appendChild(itemInput);
      row.appendChild(itemCell);

      var categoryCell = document.createElement("td");
      var categorySelect = document.createElement("select");
      categorySelect.className = "cell-select";
      categorySelect.name = "category";
      var categories = ["Asset", "Liability", "Equity"];
      for (var i = 0; i < categories.length; i++) {
        var opt = document.createElement("option");
        opt.value = categories[i];
        opt.textContent = categories[i];
        categorySelect.appendChild(opt);
      }
      categorySelect.value = categoryValue;
      categoryCell.appendChild(categorySelect);
      row.appendChild(categoryCell);

      var amountCell = document.createElement("td");
      amountCell.className = "amount-cell";
      var rupeeSpan = document.createElement("span");
      rupeeSpan.className = "rupee-prefix";
      rupeeSpan.textContent = "‚Çπ";
      var amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.step = "0.01";
      amountInput.min = "0";
      amountInput.className = "cell-input amount";
      amountInput.name = "amount";
      amountInput.placeholder = "0.00";
      amountInput.value = amountValue;

      amountCell.appendChild(rupeeSpan);
      amountCell.appendChild(amountInput);
      row.appendChild(amountCell);

      var actionCell = document.createElement("td");
      actionCell.className = "action-cell";
      var deleteBtn = document.createElement("button");
      deleteBtn.type = "button";
      deleteBtn.className = "row-btn";
      deleteBtn.textContent = "‚úï";
      deleteBtn.title = "Delete row";
      actionCell.appendChild(deleteBtn);
      row.appendChild(actionCell);

      tbody.appendChild(row);
      updateRowNumbers();

      function bindInput(el) {
        el.addEventListener("focus", function () {
          updateFormulaDisplay(row, el);
        });
        el.addEventListener("input", function () {
          updateFormulaDisplay(row, el);
          calculateTotals();
        });
      }
      bindInput(itemInput);
      bindInput(categorySelect);
      bindInput(amountInput);

      deleteBtn.addEventListener("click", function () {
        if (row.parentNode) {
          row.parentNode.removeChild(row);
        }
        updateRowNumbers();
        calculateTotals();
      });

      itemInput.addEventListener("focus", function () {
        updateFooterStatus("Editing item‚Ä¶");
      });
      amountInput.addEventListener("focus", function () {
        updateFooterStatus("Editing amount‚Ä¶");
      });

      return row;
    }

    function updateRowNumbers() {
      var rows = document.querySelectorAll("#sheetBody tr");
      nodeListForEach(rows, function (row, index) {
        var indexCell = row.querySelector(".index-cell");
        if (indexCell) indexCell.textContent = index + 1;
      });
    }

    function updateFormulaDisplay(row, element) {
      var formulaDisplay = document.getElementById("formulaDisplay");
      var rowIndex = row.rowIndex; // includes header row
      var cell = element.parentElement;
      while (cell && cell.tagName !== "TD") {
        cell = cell.parentElement;
      }
      var colIndex = cell ? cell.cellIndex : 0;
      var colLetters = ["A", "B", "C", "D", "E", "F", "G"];
      var colLetter = colLetters[colIndex] || "?";
      var cellLabel = colLetter + String(rowIndex);

      var description = "";
      if (element.name === "item") description = "Item / Account";
      else if (element.name === "category") description = "Category";
      else if (element.name === "amount") description = "Amount (‚Çπ)";

      formulaDisplay.textContent =
        "[" + cellLabel + "] " + description + ": " + element.value;
    }

    function updateFooterStatus(message) {
      var footerStatus = document.getElementById("footerStatus");
      footerStatus.textContent = message;
    }

    function getTableData() {
      var rows = document.querySelectorAll("#sheetBody tr");
      var data = [];
      nodeListForEach(rows, function (row, index) {
        var itemInput = row.querySelector('input[name="item"]');
        var catSelect = row.querySelector('select[name="category"]');
        var amtInput = row.querySelector('input[name="amount"]');

        var item = itemInput ? itemInput.value : "";
        var category = catSelect ? catSelect.value : "";
        var amount = amtInput ? parseFloat(amtInput.value) || 0 : 0;

        data.push({
          "#": index + 1,
          "Item / Account": item,
          "Category": category,
          "Amount (‚Çπ)": Number(amount.toFixed(2))
        });
      });
      return data;
    }

    function computeTotalsFromData(data) {
      var acc = { assets: 0, liabilities: 0, equity: 0 };
      for (var i = 0; i < data.length; i++) {
        var row = data[i];
        var amt = Number(row["Amount (‚Çπ)"]) || 0;
        if (row.Category === "Asset") acc.assets += amt;
        else if (row.Category === "Liability") acc.liabilities += amt;
        else if (row.Category === "Equity") acc.equity += amt;
      }
      return acc;
    }

    function saveToStorage() {
      try {
        var data = getTableData();
        var json = JSON.stringify(data);
        localStorage.setItem(STORAGE_KEY, json);
      } catch (e) {
        // ignore if blocked
      }
    }

    function loadFromStorage() {
      try {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        var data = JSON.parse(raw);
        if (!data || !data.length) return false;

        var tbody = document.getElementById("sheetBody");
        tbody.innerHTML = "";
        for (var i = 0; i < data.length; i++) {
          var row = data[i];
          createRow(
            row["Item / Account"] || "",
            row["Category"] || "Asset",
            row["Amount (‚Çπ)"] != null ? String(row["Amount (‚Çπ)"]) : ""
          );
        }
        calculateTotals();
        return true;
      } catch (e) {
        return false;
      }
    }

    function calculateTotals() {
      var data = getTableData();
      var totals = computeTotalsFromData(data);

      document.getElementById("totalAssets").innerHTML =
        '<span class="rupee">‚Çπ</span>' + formatAmount(totals.assets);
      document.getElementById("totalLiabilities").innerHTML =
        '<span class="rupee">‚Çπ</span>' + formatAmount(totals.liabilities);
      document.getElementById("totalEquity").innerHTML =
        '<span class="rupee">‚Çπ</span>' + formatAmount(totals.equity);

      var leftSide = totals.assets;
      var rightSide = totals.liabilities + totals.equity;
      var difference = leftSide - rightSide;

      var balanceStatus = document.getElementById("balanceStatus");
      var differenceHint = document.getElementById("differenceHint");
      var tolerance = 0.01;

      if (Math.abs(difference) <= tolerance && (leftSide !== 0 || rightSide !== 0)) {
        balanceStatus.className = "summary-badge ok";
        balanceStatus.innerHTML =
          '<span class="summary-badge-dot"></span> Balanced';
      } else {
        balanceStatus.className = "summary-badge bad";
        balanceStatus.innerHTML =
          '<span class="summary-badge-dot"></span> Not balanced';
      }

      differenceHint.innerHTML =
        'Difference: <span class="rupee">‚Çπ</span>' + formatAmount(difference);

      updateFooterStatus("Totals updated.");
      saveToStorage();
    }

    function downloadExcel() {
      if (typeof XLSX === "undefined") {
        alert("Excel export library not loaded. Check your internet connection.");
        return;
      }
      var data = getTableData();
      if (!data.length) {
        alert("No data to export.");
        return;
      }
      var ws = XLSX.utils.json_to_sheet(data);
      var wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "BalanceSheet");
      XLSX.writeFile(wb, "balance-sheet.xlsx");
      updateFooterStatus("Exported as Excel (.xlsx).");
    }

    function downloadCsv() {
      var data = getTableData();
      if (!data.length) {
        alert("No data to export.");
        return;
      }
      var headers = Object.keys(data[0]);
      var csvRows = [];
      csvRows.push(headers.join(","));
      for (var i = 0; i < data.length; i++) {
        var row = data[i];
        var values = [];
        for (var j = 0; j < headers.length; j++) {
          var h = headers[j];
          var val = row[h] == null ? "" : row[h];
          var str = String(val);
          if (/[,"]/.test(str)) {
            str = '"' + str.replace(/"/g, '""') + '"';
          }
          values.push(str);
        }
        csvRows.push(values.join(","));
      }
      var csvContent = csvRows.join("\n");
      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var link = document.createElement("a");
      link.href = url;
      link.download = "balance-sheet.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      updateFooterStatus("Exported as CSV.");
    }

    function downloadPdf() {
      if (!window.jspdf || typeof window.jspdf.jsPDF === "undefined") {
        alert("PDF export library not loaded. Check your internet connection.");
        return;
      }
      var data = getTableData();
      if (!data.length) {
        alert("No data to export.");
        return;
      }
      var totals = computeTotalsFromData(data);

      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF();

      doc.setFontSize(14);
      doc.text("Balance Sheet (‚Çπ)", 14, 16);
      doc.setFontSize(10);
      doc.text("Auto-generated from Balance Sheet Web App", 14, 22);

      var head = [["#", "Item / Account", "Category", "Amount (‚Çπ)"]];
      var body = [];
      for (var i = 0; i < data.length; i++) {
        var row = data[i];
        body.push([
          row["#"],
          row["Item / Account"],
          row["Category"],
          row["Amount (‚Çπ)"].toFixed(2)
        ]);
      }

      doc.autoTable({
        head: head,
        body: body,
        startY: 28,
        theme: "grid",
        styles: { fontSize: 9 },
        headStyles: { fillColor: [15, 23, 42], textColor: [226, 232, 240] }
      });

      var finalY = (doc.lastAutoTable && doc.lastAutoTable.finalY) || 28;

      doc.setFontSize(11);
      doc.text("Total Assets: ‚Çπ" + totals.assets.toFixed(2), 14, finalY + 10);
      doc.text("Total Liabilities: ‚Çπ" + totals.liabilities.toFixed(2), 14, finalY + 16);
      doc.text("Total Equity: ‚Çπ" + totals.equity.toFixed(2), 14, finalY + 22);
      var diff = totals.assets - (totals.liabilities + totals.equity);
      doc.text(
        "Difference (Assets - Liabilities - Equity): ‚Çπ" + diff.toFixed(2),
        14,
        finalY + 28
      );

      doc.save("balance-sheet.pdf");
      updateFooterStatus("Exported as PDF.");
    }

    function downloadHtml() {
      var data = getTableData();
      var html = "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Balance Sheet Export</title>";
      html += "<style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #888;padding:4px;text-align:left;}</style>";
      html += "</head><body><h2>Balance Sheet (‚Çπ)</h2><table><thead><tr>";
      var headers = ["#", "Item / Account", "Category", "Amount (‚Çπ)"];
      for (var i = 0; i < headers.length; i++) {
        html += "<th>" + headers[i] + "</th>";
      }
      html += "</tr></thead><tbody>";
      for (var r = 0; r < data.length; r++) {
        var row = data[r];
        html += "<tr>";
        html += "<td>" + row["#"] + "</td>";
        html += "<td>" + (row["Item / Account"] || "") + "</td>";
        html += "<td>" + (row["Category"] || "") + "</td>";
        html += "<td>‚Çπ" + row["Amount (‚Çπ)"].toFixed(2) + "</td>";
        html += "</tr>";
      }
      html += "</tbody></table></body></html>";
      var blob = new Blob([html], { type: "text/html;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var link = document.createElement("a");
      link.href = url;
      link.download = "balance-sheet.html";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      updateFooterStatus("Exported as HTML.");
    }

    function downloadJson() {
      var data = getTableData();
      var json = JSON.stringify(data, null, 2);
      var blob = new Blob([json], { type: "application/json;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var link = document.createElement("a");
      link.href = url;
      link.download = "balance-sheet.json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      updateFooterStatus("Exported as JSON.");
    }

    function resetSheet() {
      if (!confirm("Clear all rows and reset the sheet?")) return;
      var tbody = document.getElementById("sheetBody");
      tbody.innerHTML = "";
      createRow("Cash in Hand", "Asset", "0");
      createRow("Bank Balance", "Asset", "0");
      createRow("Furniture", "Asset", "0");
      createRow("Loan from Bank", "Liability", "0");
      createRow("Capital", "Equity", "0");
      calculateTotals();
      document.getElementById("formulaDisplay").textContent =
        "Click any cell to see / edit details";
      updateFooterStatus("Sheet reset.");
    }

    document.addEventListener("DOMContentLoaded", function () {
      var loaded = loadFromStorage();
      if (!loaded) {
        createRow("Cash in Hand", "Asset", "0");
        createRow("Bank Balance", "Asset", "0");
        createRow("Furniture", "Asset", "0");
        createRow("Loan from Bank", "Liability", "0");
        createRow("Capital", "Equity", "0");
        calculateTotals();
      }

      document.getElementById("addRowBtn").addEventListener("click", function () {
        createRow();
        calculateTotals();
        updateFooterStatus("Row added.");
      });

      document.getElementById("addRowBtn2").addEventListener("click", function () {
        createRow();
        calculateTotals();
        updateFooterStatus("Row added.");
      });

      document.getElementById("recalcBtn").addEventListener("click", calculateTotals);
      document.getElementById("downloadExcelBtn").addEventListener("click", downloadExcel);
      document.getElementById("downloadCsvBtn").addEventListener("click", downloadCsv);
      document.getElementById("downloadPdfBtn").addEventListener("click", downloadPdf);
      document.getElementById("downloadHtmlBtn").addEventListener("click", downloadHtml);
      document.getElementById("downloadJsonBtn").addEventListener("click", downloadJson);
      document.getElementById("resetSheetBtn").addEventListener("click", resetSheet);
    });
  </script>
</body>
</html>
